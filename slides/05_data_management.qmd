---
subtitle: "Data management and transformation"
---

```{r}
#| include: false
suppressPackageStartupMessages({
  library(tidyverse)
  library(readxl)
  library(EVR628tools)
  library(knitr)
})

theme_set(
  theme_bw(base_size = 20)
)
```

## Learning Objectives

:::{.callout-note}
## By the end of this week, you should be able to:
- File paths
- Reading and writing tabular data (`*.xlsx`, `*csv` and `*.rds`)
- Modifying rows (filter, arrange, distinct) with `{dplyr}`
- Modifying columns (select, rename) with `{dplyr}`
- Grouping and summarizing data with `{dplyr}`
:::

## Today's class

- File paths and working directories
- Reading and writing data

# File paths and working directories

## Understanding File Paths

**File path**: The location of a file on your computer

. . .

**Two types of paths**:

- **Absolute path**: Complete address from the root directory
  - Example: `/Users/jcvd/GitHub/EVR_628/data/raw/lionfish.csv`
- **Relative path**: Address relative to your current working directory
  - Example: `data/raw/lionfish.csv`

## Working Directory

**Working directory**: The folder R considers as "home" for your current session

. . .

```{r}
#| code-fold: false
# Check current working directory
getwd()

# List files in current directory
list.files()

# List files in a specific directory
list.files("data")
```

:::{.callout-important}
**Best Practice**: Use RStudio projects instead of `setwd()`
:::

## RStudio Projects and File Paths

**Why projects are better**:

- Working directory is automatically set
- Relative paths work consistently
- Easy to share and reproduce
- No need to remember absolute paths

. . .

```{r}
#| code-fold: false
#| eval: false
# In an RStudio project, these work the same way:
read.csv("data/raw/lionfish.csv")
read.csv("data/raw/lionfish.csv")
```

# Reading and writing data

## Common Data File Types

:::: {.columns}

::: {.column width='33%'}
**CSV Files**
- Comma-separated values
- Universal format
- Human-readable
- Good for small datasets
:::

::: {.column width='33%'}
**Excel Files**
- `.xlsx` format
- Can have multiple sheets
- Preserves formatting
- Common in business
:::

::: {.column width='33%'}
**RDS Files**
- R's native format
- Preserves data types
- Compressed
- Fastest to read/write
:::

::::

## Reading CSV Files

```{r}
#| code-fold: false
#| eval: false
# Basic CSV reading
data <- read.csv("data/raw/lionfish.csv")

# With more options
data <- read.csv("data/raw/lionfish.csv", 
                 header = TRUE,
                 stringsAsFactors = FALSE)

# Using readr (tidyverse)
data <- read_csv("data/raw/lionfish.csv")
```

## Reading Excel Files

```{r}
#| code-fold: false
#| eval: false
# Install if needed
# install.packages("readxl")

# Load package
library(readxl)

# Read first sheet
data <- read_excel("data/raw/lionfish.xlsx")

# Read specific sheet
data <- read_excel("data/raw/lionfish.xlsx", 
                   sheet = "Sheet2")

# Read with column types
data <- read_excel("data/raw/lionfish.xlsx",
                   col_types = c("text", "numeric", "numeric"))
```

## Reading RDS Files

```{r}
#| code-fold: false
#| eval: false
# Reading RDS files
data <- readRDS("data/raw/lionfish.rds")

# Using readr
data <- read_rds("data/raw/lionfish.rds")
```

## Writing Data Files

```{r}
#| code-fold: false
#| eval: false
# Write CSV
write.csv(data, "data/processed/lionfish_clean.csv", 
          row.names = FALSE)

# Write CSV with readr
write_csv(data, "data/processed/lionfish_clean.csv")

# Write Excel
library(openxlsx)
write.xlsx(data, "data/processed/lionfish_clean.xlsx")

# Write RDS
saveRDS(data, "data/processed/lionfish_clean.rds")
write_rds(data, "data/processed/lionfish_clean.rds")
```

## Example: Working with Real Data

```{r}
#| code-fold: false
# Load the lionfish data
data_lionfish
```

. . .

Let's explore this dataset and practice data management techniques.

## Today's class

- Data transformation with `{dplyr}`
- Row operations: filter, arrange, distinct
- Column operations: select, rename
- Grouping and summarizing

# Data transformation with `{dplyr}`

## The `{dplyr}` Package

**`{dplyr}`**: A grammar of data manipulation

. . .

**Core functions**:

- `filter()`: Pick observations by their values
- `arrange()`: Reorder rows
- `select()`: Pick variables by their names
- `mutate()`: Create new variables with functions of existing variables
- `summarise()`: Collapse many values down to a single summary
- `group_by()`: Change the scope of each function from operating on the entire dataset to operating on it group-by-group

## Loading `{dplyr}`

```{r}
#| code-fold: false
# Load dplyr (part of tidyverse)
library(tidyverse)

# Or load just dplyr
library(dplyr)
```

# Row operations

## Filtering Rows with `filter()`

**`filter()`**: Keep rows that match your conditions

. . .

```{r}
#| code-fold: false
# Basic filtering
large_fish <- filter(data_lionfish, total_length_mm > 200)

# Multiple conditions
paamul_large <- filter(data_lionfish, 
                       site == "Paamul", 
                       total_length_mm > 200)

# Using logical operators
medium_or_large <- filter(data_lionfish, 
                          size_class == "medium" | size_class == "large")
```

## Filtering with Logical Operators

:::: {.columns}

::: {.column width='50%'}
**Comparison operators**:
- `>`: Greater than
- `>=`: Greater than or equal
- `<`: Less than
- `<=`: Less than or equal
- `==`: Equal to
- `!=`: Not equal to
:::

::: {.column width='50%'}
**Logical operators**:
- `&`: AND
- `|`: OR
- `!`: NOT
- `%in%`: Match any of
:::

::::

## More Filtering Examples

```{r}
#| code-fold: false
# Using %in%
specific_sites <- filter(data_lionfish, 
                        site %in% c("Paamul", "Castillo"))

# Using is.na() and !is.na()
complete_data <- filter(data_lionfish, 
                        !is.na(depth_m))

# Complex conditions
deep_large_fish <- filter(data_lionfish,
                          depth_m > 10,
                          total_length_mm > 150,
                          site != "Tzimin-Ha")
```

## Arranging Rows with `arrange()`

**`arrange()`**: Reorder rows by column values

. . .

```{r}
#| code-fold: false
# Sort by length (ascending)
by_length <- arrange(data_lionfish, total_length_mm)

# Sort by length (descending)
by_length_desc <- arrange(data_lionfish, desc(total_length_mm))

# Sort by multiple columns
by_site_length <- arrange(data_lionfish, site, total_length_mm)
```

## Finding Distinct Rows with `distinct()`

**`distinct()`**: Remove duplicate rows

. . .

```{r}
#| code-fold: false
# Get unique sites
unique_sites <- distinct(data_lionfish, site)

# Get unique combinations
unique_combinations <- distinct(data_lionfish, site, size_class)

# Remove all duplicates
no_duplicates <- distinct(data_lionfish)
```

# Column operations

## Selecting Columns with `select()`

**`select()`**: Choose columns by name

. . .

```{r}
#| code-fold: false
# Select specific columns
basic_info <- select(data_lionfish, id, site, total_length_mm)

# Select columns by position
first_three <- select(data_lionfish, 1:3)

# Select columns by pattern
length_cols <- select(data_lionfish, contains("length"))

# Exclude columns
no_weights <- select(data_lionfish, -contains("weight"))
```

## Helper Functions for `select()`

:::: {.columns}

::: {.column width='50%'}
**Selection helpers**:
- `starts_with()`: Starts with prefix
- `ends_with()`: Ends with suffix
- `contains()`: Contains substring
- `matches()`: Matches regex
- `num_range()`: Numeric range
:::

::: {.column width='50%'}
**Position helpers**:
- `everything()`: All columns
- `last_col()`: Last column
- `where()`: Where condition
:::

::::

## Renaming Columns with `rename()`

**`rename()`**: Change column names

. . .

```{r}
#| code-fold: false
# Rename specific columns
renamed_data <- rename(data_lionfish,
                       fish_id = id,
                       length_mm = total_length_mm,
                       weight_gr = total_weight_gr)

# Rename all columns to lowercase
lowercase_data <- rename_with(data_lionfish, tolower)
```

## Creating New Columns with `mutate()`

**`mutate()`**: Add new columns or modify existing ones

. . .

```{r}
#| code-fold: false
# Create new columns
with_ratios <- mutate(data_lionfish,
                      length_weight_ratio = total_length_mm / total_weight_gr,
                      length_category = ifelse(total_length_mm > 200, "large", "small"))

# Modify existing columns
standardized <- mutate(data_lionfish,
                       length_std = (total_length_mm - mean(total_length_mm)) / sd(total_length_mm))
```

## Conditional Logic in `mutate()`

```{r}
#| code-fold: false
# Using ifelse()
categorized <- mutate(data_lionfish,
                      size_category = ifelse(total_length_mm > 200, "large",
                                           ifelse(total_length_mm > 100, "medium", "small")))

# Using case_when()
categorized_v2 <- mutate(data_lionfish,
                         size_category = case_when(
                           total_length_mm > 200 ~ "large",
                           total_length_mm > 100 ~ "medium",
                           TRUE ~ "small"
                         ))
```

# Grouping and summarizing

## Grouping Data with `group_by()`

**`group_by()`**: Group data by one or more variables

. . .

```{r}
#| code-fold: false
# Group by site
by_site <- group_by(data_lionfish, site)

# Group by multiple variables
by_site_size <- group_by(data_lionfish, site, size_class)

# Check grouping
group_vars(by_site)
```

## Summarizing Data with `summarise()`

**`summarise()`**: Collapse groups to single values

. . .

```{r}
#| code-fold: false
# Basic summary
summary_stats <- summarise(data_lionfish,
                          mean_length = mean(total_length_mm),
                          max_length = max(total_length_mm),
                          n_fish = n())

# Summary by group
by_site_summary <- data_lionfish %>%
  group_by(site) %>%
  summarise(mean_length = mean(total_length_mm),
            max_length = max(total_length_mm),
            n_fish = n())
```

## Common Summary Functions

:::: {.columns}

::: {.column width='50%'}
**Count functions**:
- `n()`: Number of observations
- `n_distinct()`: Number of unique values
- `sum(!is.na())`: Count non-missing
:::

::: {.column width='50%'}
**Summary functions**:
- `mean()`, `median()`, `sd()`
- `min()`, `max()`, `quantile()`
- `first()`, `last()`, `nth()`
:::

::::

## More Summarizing Examples

```{r}
#| code-fold: false
# Multiple summary statistics
detailed_summary <- data_lionfish %>%
  group_by(site) %>%
  summarise(
    n_fish = n(),
    mean_length = mean(total_length_mm),
    median_length = median(total_length_mm),
    sd_length = sd(total_length_mm),
    min_length = min(total_length_mm),
    max_length = max(total_length_mm),
    .groups = "drop"
  )

# Summary with conditions
large_fish_summary <- data_lionfish %>%
  filter(total_length_mm > 150) %>%
  group_by(site) %>%
  summarise(n_large_fish = n(),
            .groups = "drop")
```

## The Pipe Operator `|>`

**Pipes**: Chain operations together for cleaner code

. . .

```{r}
#| code-fold: false
# Without pipes (nested)
result <- summarise(
  group_by(
    filter(data_lionfish, total_length_mm > 150),
    site
  ),
  n_large_fish = n()
)

# With pipes (cleaner)
result <- data_lionfish %>%
  filter(total_length_mm > 150) %>%
  group_by(site) %>%
  summarise(n_large_fish = n())
```

## Complete Data Management Workflow

```{r}
#| code-fold: false
# Complete workflow example
analysis_data <- data_lionfish %>%
  # Filter for complete data
  filter(!is.na(depth_m)) %>%
  # Create new variables
  mutate(
    length_category = case_when(
      total_length_mm > 200 ~ "large",
      total_length_mm > 100 ~ "medium",
      TRUE ~ "small"
    ),
    length_weight_ratio = total_length_mm / total_weight_gr
  ) %>%
  # Select relevant columns
  select(site, size_class, length_category, total_length_mm, total_weight_gr, length_weight_ratio) %>%
  # Group and summarize
  group_by(site, length_category) %>%
  summarise(
    n_fish = n(),
    mean_length = mean(total_length_mm),
    mean_weight = mean(total_weight_gr),
    .groups = "drop"
  ) %>%
  # Arrange results
  arrange(site, desc(mean_length))
```

## Best Practices for Data Management

:::: {.columns}

::: {.column width='50%'}
**File organization**:
- Use relative paths
- Keep raw data separate
- Document your process
- Use meaningful names
:::

::: {.column width='50%'}
**Code organization**:
- Use pipes for readability
- Comment your code
- Test on small datasets first
- Save intermediate results
:::

::::

## Common Pitfalls to Avoid

- **Forgetting to ungroup**: After `group_by()`, remember to `ungroup()` or use `.groups = "drop"`
- **Overwriting data**: Use `<-` to save results to new objects
- **Missing values**: Check for `NA` values with `is.na()` and `complete.cases()`
- **Data types**: Ensure columns have the correct data types
- **File paths**: Use projects and relative paths

## Learning Objectives - Revisited

:::{.callout-note}
## By the end of this week, you should be able to:
- File paths
- Reading and writing tabular data (`*.xlsx`, `*csv` and `*.rds`)
- Modifying rows (filter, arrange, distinct) with `{dplyr}`
- Modifying columns (select, rename) with `{dplyr}`
- Grouping and summarizing data with `{dplyr}`
:::

. . .

Before Thursday: Read [Chapter 7](https://r4ds.hadley.nz/data-import.html) and [Chapter 3](https://r4ds.hadley.nz/data-transform.html) of R4DS

# Let's get coding

## Exercises

My guide for [live coding](https://jcvdav.github.io/EVR_628/docs/05_live.html)

# References
