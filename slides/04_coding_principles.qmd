---
subtitle: "Coding principles"
---

```{r}
#| echo: false
#| warnings: false
#| message: false
library(EVR628tools)
library(tidyverse)
```

## So Far

- You've trusted me and executed code as instructed
- I didn't give you much background on what you were doing
- Clearly something clicked; you are still here
- Let's give you a bit more background

## Learning Objectives

:::{.callout-note}
## By the end of this week, you should be able to:
- Explain the importance of code style and documentation
- Know about "atomic" objects and how they relate to all things R
- Understand and check object classes
- Create, subset, and modify vectors and data frames
- Use the `pipe` operator
:::

# Code _style_

Helping others (and future you) read your code

## Comments

- Text embedded within your script for humans to read

- Helps other people (including future you) understand what's going on

- We use the `#` sign to prevent the computer from reading it
  - Works in R, Python, Make, Julia, SQL

## Comments: Some guidelines

- What are you doing?
- Why are you doing it _that way_?
  - Focus on explaining _why_ you did something, not _what_ you are doing (or _how_)
- Try to keep your comments within the vertical line show in RStudio

. . .

Is this comment helpful?

```{r}
#| code-fold: false
# Shark analysis
lengths <- c(6, 4.1, 2.8, 5.5, 3.9, 5.8)
sharks <- c("Great White Shark", "Lemon Shark", "Bull Shark", "Hammerhead Shark", "Mako Shark", "Great White Shark")
shark_data <- data.frame(
  lengths,
  sharks
)
shark_data$sharks[shark_data$length == max(shark_data$length)]
```

## Comments: Some guidelines

How about this?

```{r}
#| code-fold: false
#| code-line-numbers: "1-7|9-13|15-16"
# Build data
## Vector of shark lengths
lengths <- c(6, 4.1, 2.8, 5.5, 3.9, 5.8)
## Vector of shark names
sharks <- c("Great White Shark", "Lemon Shark",
            "Bull Shark", "Hammerhead Shark",
            "Mako Shark", "Great White Shark")

# Combine vectors into a data.frame
shark_data <- data.frame(
  lengths,
  sharks
)

# Find the length for the largest great white
shark_data$lengths[shark_data$sharks == "Great White Shark"] |> max()
```


## Sectioning with comments

- A script contains more than one bit of code, often dozens of lines

- R can detect up to 6 levels, as indicated by the number of "`#`"

. . .

:::: {.columns}

::: {.column width='50%'}
```r
################################################################################
# Description goes here
################################################################################

# SET UP #######################################################################

## Load packages ---------------------------------------------------------------

## Load data -------------------------------------------------------------------


# PROCESSING ###################################################################

## Some step -------------------------------------------------------------------


# VISUALIZE ####################################################################

## Another step ----------------------------------------------------------------


# EXPORT #######################################################################

## The final step --------------------------------------------------------------
```
:::

::: {.column width='50%'}
![](img/outline_comments.png){.nostretch fig-align="center" width="90%"}
:::

::::


## Naming conventions (super important)

- Objects
- Files
- Directories

. . .

```{r}
#| eval: false
#| code-fold: false
i_use_snake_case                   # This is my preference

otherPeopleUseCamelCase            # This sometimes works

some.people.use.periods            # This is dangerous, especially in python

And_aFew.People_RENOUNCEconvention # You need help

ALL_CAPS                           # Reserved for super important stuff
```

- [Google Code Style Guide](https://google.github.io/styleguide/)


## Spaces

Use spaces:

- around mathematical operators apart from `^` (i.e. `+` , `-` , `==` , `<` , …)
- around the assignment operator ( `<-` )
- around pipes ( `|>` and `%>%`)


. . .

```{r}
#| eval: false
#| code-fold: false
# Strive for
y <- (m * x) + b

# Avoid
y<-(m*x)+b

# Avoid
 y <- ( m * x ) + b
```

- No spaces around parentheses for regular function calls
- Always put a space after a comma, just like in standard English.

. . .

```{r}
#| eval: false
#| code-fold: false
# Strive for
mean(x, na.rm = TRUE)

# Avoid
mean (x ,na.rm=TRUE)
```

## Indentation and line separation


:::: {.columns}

::: {.column width='50%'}
Not great

```{r}
#| eval: false
#| code-fold: false
library(EVR628tools)
library(tidyverse)
data("data_lionfish")
my_data<-data_lionfish[data_lionfish$site=="Paamul",]
ggplot(data=my_data,
mapping=aes(x=depth_m,y=total_length_mm))+
geom_point(shape=21,fill="steelblue",size=2)+
labs(x="Depth(m)",
y="Totallength(mm)",
title="Bodylengthanddepth",
subtitle="Largerfishtendtolivedeeper",
caption="SourceEVR628tools::data_lionfish")
```
:::

::: {.column width='50%'}
Better

```{r}
#| eval: false
#| code-fold: false
# Load packages
library(EVR628tools)
library(tidyverse)

# Load data
data("data_lionfish")

# Build my own data
my_data <- data_lionfish[data_lionfish$site == "Paamul",]

# Build my plot
ggplot(data = my_data,
       mapping = aes(x = depth_m, y = total_length_mm)) +
  geom_point(shape = 21, fill = "steelblue", size = 2) +
  labs(x = "Depth (m)",
       y = "Total length (mm)",
       title = "Body length and depth",
       subtitle = "Larger fish tend to live deeper",
       caption = "Source EVR628tools::data_lionfish")
```
:::

::::

. . .

Use `Cmd` + `i` to auto-indent

- line by line
- select code chunk and then indent


# "Objects" and "Classes"

Things and types of things

## Atomic objects

The most common _atomic_ classes are:

- character: `"a"` or `'b'` (note the quotation marks)
- numeric: `2` or `10e3` (note scientific notation)
- logical: `TRUE`/`FALSE` or `T`/`F`, but never `true`/`false` (note no quotations)

. . .

:::: {.columns}

::: {.column width='50%'}
You can check classes with function `class()`

```{r}
#| code-fold: false
class("a")

class(2)

class("2") # This is no longer a number

class(TRUE)
```


:::

::: {.column width='50%'}

Coercing "up" is safe

```{r}
#| code-fold: false
as.character(20)
as.numeric(TRUE) # Logical to numeric
```

Coercing "down"... not always

```{r}
#| code-fold: false
as.numeric("a") # Character to numeric
```


:::

::::

## Object _classes_

Classes in R map to the types of data we during Week 2:

- _numerical_ data in R are of _class_ `numeric`
- _cetegorical_ data in R are of _class_ `character`
- _ordinal_ data in R are a special _class_ of `character` called `factor`
  - Remember when we ordered the axis label in a ggplot using `fct_infreq()`?

## Creating "objects"

- If you'll need a value, dataset or plot for later, you should "assign it"
- This will retain the object in your **environment** tab, leaving available for later
- You will use the _assignment operator_: `<-`
  - Mac shortcut: `Opt` + `-`
  - Windows shortcut: `Alt` + `-`
- Read "`<-`" as: "gets a value of"
  
. . .

Save something (pretty much anything) by creating an object

```{r}
#| code-fold: false
#| code-line-numbers: "1-2|3-6"
# A number
my_num <- 2 # Read as: my_num gets a value of 2
# piece of text
my_name <- "JC" # Read as: my_name gets a value of JC
```

## Creating "objects"

:::: {.columns}

::: {.column width='50%'}
They will appear in your **environment** pane

![](img/environment.png)

:::

::: {.column width='50%'}

And you can "call them" later

```{r}
#| code-fold: false
#| error: true
my_num # Call your object in the console

my_num + 2 # Use your object in other operations

my_number # This line should fail.. Why?
```

:::
::::

. . .

You can use `class()` to check what each thing is

```{r}
#| code-fold: false
class(my_num)
class(my_name)
```

# Operators

## Binary Operators: Arithmetic

:::: {.columns}
::: {.column width='50%'}

```{r}
#| code-fold: false
2 + 2 # Addition

10 - 1 # Subtraction

10 * 3 # Multiplication

10 / 3 # Division

2^4 # Exponentiation

64 ^ (1/2) # Roots as powers...
```

:::

::: {.column width='50%'}
**_Arithmetic Operators:_**

- Stand between two values
- Perform arithmetic on objects of class `numeric` (or objects that can be coerced to them)
  - "coercion" here means "conversion"
  - `TRUE` or `FALSE` (logical values) can be "coerced" to ones and zeroes
- Return an object of class `numeric`

:::
::::

## Binary Operators: Relational
:::: {.columns}
::: {.column width='50%'}
```{r}
#| code-fold: false
2 < 3  # Less than?
2 > 3  # Greater than?
2 <= 3 # Les than or equal to?
2 >= 3 # Greater than or equal to?
2 == 3 # Equal to?

# Also works with characters
"hotdog" == "sandwich" # Equal?
```
:::

::: {.column width='50%'}

**_Relational operators_**

- Allow comparison of objects of all _atomic_ objects
- Return an object of class `logical`

:::

::::


## Binary Operators: Logical

```{r}
#| code-fold: false
(2 == 2) & ("a" == "b") # Are statements to the left AND right TRUE?
(2 == 2) | ("a" == "b") # Are statements to the left OR right TRUE?
!T # Negate the statement
```

. . .

- Allow comparison of objects of class _logical_
- Return an object of class `logical`



# Combining objects

## Combining Atomic Objects

- You can combine atomic elements with function "`c()`"

- `c` stands for "`c`ombine"

. . .

```{r}
#| code-fold: false
colors <- c("red", "blue", "green", "orange", "black")
numbers <- c(1, 40, 1, 5, 6)
```

- The objects called `colors` and `numbers` are _vectors_ of class `character` and `numeric`

. . .

```{r}
#| code-fold: false
class(colors)
class(numbers)
```


- Vectors are like columns in a spreadsheet

- Vectors have lengths: number of elements

. . .

```{r}
#| code-fold: false
#| results: false
length(colors)
```

```{r}
#| code-fold: false
#| echo: false
length(colors)
```


## Operating on Vectors

If the vector is numeric, arithmetic operations are applied to every element automatically

```{r}
#| code-fold: false
numbers <- 1:10
numbers
numbers * 2 # Multiplies each element x 2
numbers + 5 # Adds 5 to each element
```

- Arithmetic operations don't work on character vectors

. . .

```{r}
#| code-fold: false
#| error: true
colors <- c("red", "blue", "green", "orange", "black")
colors * 2
```

:::{.callout-note}
What does the error message above mean?
:::

## Indexing and subsetting vectors with `[]`

Accessing elements within an object based on their position

Read "`[]`" as "extract elements"

```{r}
#| code-fold: false
colors <- c("red", "blue", "green", "orange", "black") # Create a character vector of colors
```

. . .

I can extract the first element with:

```{r}
#| code-fold: false
colors[1] # Extract first element
```

. . .

Extract the first and third elements

```{r}
#| code-fold: false
colors[c(1, 3)] # Extract elements 1 and 3
```
. . .

Extract elements based on logical matching

```{r}
#| code-fold: false
colors == "red"
colors[!colors == "red"]
```

## Indexing with `[]` and modify with ` <- `

```{r}
#| code-fold: false
colors <- c("red", "blue", "green", "orange", "black") # Create a character vector of colors
colors
```

. . .

Let's modify red to white

```{r}
#| code-fold: false
colors[1] <- "white" # The first element of "colors" takes the value "white"

colors
```

. . .

Number of elements indexed must match number of elements assigned

```{r}
#| code-fold: false
#| error: true
#| warning: true
colors[1] <- c("white", "yellow")

colors
```


# Let's code

# Combining Different Classes

## Combining Vectors of Different Classes

- R's basic class is _data.frame_
- Having different classes between columns is OK, not within
- All vectors **must** be the same length

. . .

Build data.frame from vectors

```{r}
#| code-fold: false
#| results: false
#| code-line-numbers: "2|3|4-6"
# Build my vectors
colors <- c("red", "blue", "green", "orange", "black") # For five colors
numbers <- c(1, 40, 1, 5, 6)                           # For five numbers
# Column names are automatically assigned
data.frame(colors,
           numbers)
```

```{r}
#| echo: false
data.frame(colors,
           numbers) |> 
  gt::gt()
```


## Combining Vectors of Different Classes

:::: {.columns}

::: {.column width='50%'}
Using vectors of different lengths fails

```{r}
#| code-fold: false
#| error: true
data.frame(colors = c("red", "green", "blue"),
           numbers = c(1, 2))
```

:::

::: {.column width='50%'}
Unless they can be "recycled"

```{r}
#| code-fold: false
#| results: false
data.frame(colors = c("red", "green", "blue", "orange"),
           numbers = c(4, 2))
```

```{r}
#| echo: false
data.frame(colors = c("red", "green", "blue", "orange"),
           numbers = c(4, 2)) |> 
  gt::gt()
```
:::

::::

. . .

Note how I built the data.frame directly from atomic elements


## Combining Vectors of Different Classes

Build a data.frame and save it to an object

```{r}
#| code-fold: false
my_data <- data.frame(colors = c("red", "green"),
                      numbers = c(1, 2),
                      letters = c("A", "B"))
```

Attributes of data.frames:

```{r}
#| code-fold: false
class(my_data) # Check class
dim(my_data) # Check number of dimensions
nrow(my_data) # Check number of rows
ncol(my_data) # Check number of columns
colnames(my_data) # Check column names
```

## data.frames are step 1 in tidy data

They allow us to adhere to the standards described in Week 2:

- Each column is a _variable_
- Each row is an _observation_
- Cells contain _values_

. . .

:::: {.columns}

::: {.column width='50%'}
Tidy data
```{r}
#| echo: false
tidy_turtles <- data.frame(spp = c("C. mydas", "C. caretta"),
           sex = c("Female", "Male"),
           carapace_length = c(23, 24))

tidy_turtles
```

:::

::: {.column width='50%'}
Not tidy data
```{r}
#| echo: false
not_tidy_turtles <- tidy_turtles |> 
  t() %>%
  as.data.frame() |> 
  magrittr::set_colnames(value = c("Org 1", "Org 2")) |> 
  rownames_to_column(var = "variable")

not_tidy_turtles
```

:::

::::

- Say you have a plot of turtle carapace length by species.
- Only one of these data formats allows you to plot it with `ggplot`


## Tibbles vs data.frame

- Tibbles are a special type of data.frame used in tidyverse and spatial libraries

- They work in the same way

. . .

```{r}
#| code-fold: false
library(tidyverse)
tibble(colors,
       numbers)
```


## Tibbles vs data.frame

Tibbles are also smart

- They display their dimensions
- And let you know data have been omitted

. . .

```{r}
#| code-fold: false
data_lionfish
```

## Subsetting dataframes with `[]`

data.frames are two-dimensional, so we use two numbers: `[rows, cols]`

. . .

```{r}
#| code-fold: false
my_data
```
. . .

Extract the value for the second observation anad third variable

```{r}
#| code-fold: false
#| eval: false
my_data[1 , 3]
```

. . .

```{r}
#| echo: false
my_data[1 , 3]
```

. . .

Extract values for first observation across all variables, implicitly

```{r}
#| code-fold: false
#| eval: false
my_data[1, ] # row one, all columns
```

. . .

```{r}
#| echo: false
my_data[1,] # row one, all columns
```

. . .

Extract values for first variable across all observations, implicitly

```{r}
#| code-fold: false
#| eval: false
my_data[ , 1]
```

. . .

```{r}
#| echo: false
my_data[ , 1]
```

## Extracting data.frame columns with `$`

- Remember data.frames and tibbles are just collection of vectors
- You can get the variable (column) out as a vector using `$`
- This is why we like tidy data

. . .

```{r}
#| code-fold: false
ids <- data_lionfish$id
```

- And then use `[]` on the resulting vector
- For example, extract the first 10 ids

. . .

```{r}
#| code-fold: false
ids[1:10]
```

- This also works

. . .

```{r}
#| code-fold: false
data_lionfish$id[1:10]
```

## Indexing with `[]` and modify with ` <- `

Works in the same way as with vectors

```{r}
#| code-fold: false
my_data
```

. . .



```{r}
#| code-fold: false
my_data[1, 3] <- "turtle"
```

Which value will change?

. . .

```{r}
#| code-fold: false
my_data
```

# Functions

## Functions

A function:

- Is a block of code which only runs when it is called
- takes arguments...
- does something to them
- returns an object that used the arguments passed
- A function can do anything you want it to do

# Pipes and pipelines

## Pipes

Imagine having the following numeric vector

```{r}
#| code-fold: false
numbers <- c(1, 5, 2, 7, 9, 2, 3, 6, 3, 2, 1, 1, 6, 8, 3, 2, 1, 6, 1, 2, 8, 3,
             6, 8, 9, 0, 5, 3, 2, 1, 2, 6, 9, 2, 3, 6, 3, 2, 1, 1, 6, 8, 3, 2)

```

. . .

And wanting to know how many **unique** numbers there were

. . .

You would want to use `unique()` and then `length()`

. . .

Before **2013** you had two options:

:::: {.columns}

::: {.column width='50%'}

1: Call each function at a time

```{r}
#| code-fold: false
unique_values <- unique(numbers) # Forces you to create objects
unique_values
length(unique_values)
```

:::

::: {.column width='50%'}

2: Use nested functions

```{r}
#| code-fold: false
length(unique(numbers)) # Doesn't take much space, but hard to read
```


:::

::::

. . .

Neither is conducive to longer pipelines of chained operations


## Pipes After 2013

The `magrittr` package introduced the _pipe_ operator "`%>%`"

:::: {.columns}

::: {.column width='50%'}
!["The Treachery of Images" by René Magritte](img/MagrittePipe.jpg){.nostretch fig-align="center" width="50%"}
:::

::: {.column width='50%'}
![Pipe operator from magrittr package](img/magrittr_logo.png){.nostretch fig-align="center" width="30%"}
:::

::::


. . .

- The pipe was later popularized by `{dplyr}`
- Read "`%>%`" as "goes into"

. . .

```{r}
#| code-fold: false
library(magrittr) # Load the magrittr package

# Build a pipeline
numbers %>%      # Numbers go into unique
  unique() %>%   # The set of "unique numbers" go into "length"
  length()
```


## Pipes Since 2021

The R community saw the usefulness of this and developed a "native" pipe "`|>`"

. . .

You no longer need to load a package to use a pipe

```{r}
#| code-fold: false
numbers |> 
  unique() |> 
  length()
```

- Keyboard shortcut:
  - MacOS: `Cmd` + `Shift` + `M`
  - Windows: `Ctrl` + `Shift` + `M`

## Functions

For example, calculate the mean $\bar{x} =  \frac{\sum_{i = 1}^Nx_i}{N} = \frac{x_1 + x_2 + x_3 ... x_N}{N}$

"_Sum of all values from 1 to N, divided by the number of values_"

. . .

```{r}
#| code-fold: false
# Example: calculate mean lionfish length "by hand"
sum(data_lionfish$total_length_mm) / length(data_lionfish$total_length_mm)
```

. . .

If you have to do this for multiple variables, you might want to use a `function`

```{r}
#| code-fold: false
# Example: calculate mean lionfish length using a built-in function
mean(x = data_lionfish$total_length_mm)
```

. . .

And if the function doesn't exist, you can create one yourself (to be covered later)

```{r}
#| code-fold: false
my_mean <- function(var) {
  mean <- sum(var) / length(var)
  return(mean)
}
# Example: calculate mean lionfish length using a user-defined function
my_mean(var = data_lionfish$total_length_mm)
```



