---
title: "Data tidying and Merging"
lightbox: true
format:
  html:
    toc: true
  pdf:
    documentclass: article
echo: false
include: true
code-fold: true
---

Last week you were asked:

> How much money have tuna purse seiners made since 2000 when fishing for bigeye tuna (_Thunnus obesus_) in the Eastern Pacific Ocean?

We made some simplifying assumptions and got some values (a total of 3,070 M USD since 2000, or about 127 M USD per year). You are now tasked with coming up with more refined estimates. For example, we will account for the fact that the price of fish varies every year.

How we will approach this:

- Find data that shows prices per year and species
- Read them, clean them, tidy them up (The "data tidying" part)
- Combine our catch data from last week with this new price data (The "merging" part)
- Re-calculate our total revenues since 2000

This will require three pipelines:
- Tidy price data (Exercise 1)
- Wrangle catch data (Exercise 2)
- Combine tidy prices and catch data (Exercise 3)

Pipelines 1 and 3 contain tools covered this week. You should already be familiar with pipeline 2.

# Exercise 1: Tidying price data

## Part A: Downloading the data

**Post-it up**

1. In a web browser, go to [ffa.int](https://www.ffa.int/). This is the website for the Pacific Islands Forum Fisheries Agency
2. Hover over "Publication and Statistics" on the top menu
3. Select "Statistics"
4. You will be taken to a site with five items. Download the zip folder called `Economic and Development Indicators and Statistics: Tuna Fishery of the Western and Central Pacific Ocean 2024`
5. As before, place the downloaded zip file in your `EVR628/data/raw` folder and proceed to extract it
6. Open the excel file called `Compendium of Economic and Development Statistics 2024` and study the `Contents` tab
7. Can you identify the price data that we need?
  - Which sheet
  - What range?

**Post-it down**


## Part B: Reading excel data

**Post-it up**

1. Open your RStudio project for EVR628
2. In your console, install the `readxl` package: `install.packages("readxl")`
3. Start a **new** script called `tuna_analysis_prices.R`^[I would typically suggest to overwrite whatever we had last week in `tuna_analysis.R` because GitHub would keep a version, but I understand you might want to keep the script as is]
4. Add the usual code commenting outline
5. We will need three packages: `readxl`, `janitor`, and `tidyverse`, load them at the top of your script using `library()`
6. Use `?read_excel()` to look at the documentation for the function
7. Use `read_excel()` to create a new object called `tuna_prices` and read the price data we need^[Hint: You will need to specify a file path, a sheet, and a range of cells.]. Immediately pipe it into `clean_names`.

**Post-it down**

```{r}
#| echo: false
suppressPackageStartupMessages({
  library(readxl)
  library(janitor)
  library(tidyverse)
})
```


```{r}
library(readxl)
library(janitor)
library(tidyverse)

tuna_prices <- read_excel(path = "data/raw/Economic-and-Development-Indicators-and-Statistics-Tuna-Fishery-of-the-Western-and-Central-Pacific-Ocean-2024-32765/Compendium of Economic and Development Statistics 2024.xlsx",
                          sheet = "B. Prices",
                          range = "A35:E63",
                          na = "na") |> 
  clean_names()
```


## Part C: Inspecting price data

Be prepared to discuss the following points:

**Post-it up**

1. Inspect the column names of `tuna_prices` using `colnames()` in your console.
2. How many columns and rows do we have?
3. Any missing values?
4. Do we need to make the data wider or longer?
5. Using comments, write out what the target data should be (expand my code chunk see what I wrote)

**Post-it down**

See an example of my description below


```{r}
colnames(tuna_prices)

dim(tuna_prices)

tuna_prices |> 
  filter_all(any_vars(is.na(.)))
```

```{r}
#| code-fold: true
#| include: true
#| echo: true
# The final data set should have two columns: year and price. Since we have four
# prices (two markets, two presentations), I will use the average price per year.
# The tidy data set should therefore have four columns: year, market,
# presentation, and price.
```



## Part D: Tidy your price data

**Post-it up**

1. Look at the documentation for your `pivot_*` function. What does it say about cases where `names_to` is of length > 1?
2. What about the `names_sep` argument?
3. Use the appropriate `pivot_*` function to reshape your data and save them to a new object called `tidy_tuna_prices`^[Hint: Your `names_to` argument should be a character vector of with two items. `names_ _sep` should be inspired by our clever use of `snake_case`.]
4. Your resulting tibble should have 104 rows and 4 columns and look like this:^[Hint: If you have 112 rows, remember you can use `values_drop_na = T`]

```{r}
#| include: true
tidy_tuna_prices <- tuna_prices |> 
  pivot_longer(cols = 2:5,
               names_to = c("market", "presentation"),
               names_sep = "_",
               values_to = "price",
               values_drop_na = T)

tidy_tuna_prices
```

**Post-it down**

:::{.callout-important}
## Values in `presentation`
Note that the values in the `presentation` column are not ideal. They end in `a`, `b`, `c`, and `d` due to footnotes included in Excel. For now this doesn't matter because we will quickly remove them. We'll cover some text wrangling in Week 9.
:::


## Part E: Calculate mean annual price

**Post-it up**

1. Modify the pipeline that creates `tidy_tuna_prices` to get the mean price per year^[Hint: You will use `group_by()` and `summarize()`, as well as `|>`]

```{r}
tidy_tuna_prices <- tuna_prices |> 
  pivot_longer(cols = 2:5,
               names_to = c("market", "presentation"),
               names_sep = "_",
               values_to = "price",
               values_drop_na = T) |> 
  group_by(year) |> 
  summarize(price = mean(price))

tidy_tuna_prices
```

**Post-it down**

# Exercise 2: Tidying tuna catch data (again)

## Part A: Read the tuna catch data

>Note: You can copy-paste and modify your code from last week, but make sure your code is organized. 

**Post-it up**

1. Read in the tuna catch data from last week
2. Filter it to retain bigeye tuna (`BET`) caught by the purse seine fleet (`PS`) since 2000
3. Calculate **total** catch by year. Your final data should have 24 rows and 2 columns, as below

**Post-it down**

```{r}
#| message: false

# Load the data
tuna_data <- read_csv("data/raw/CatchByFlagGear/CatchByFlagGear1918-2023.csv") |> 
  # Clean column names
  clean_names() |>
  # Rename some columns
  rename(year = ano_year,
         flag = bandera_flag,
         gear = arte_gear,
         species = especies_species,
         catch = t)

ps_tuna_data <- tuna_data |> 
  filter(species == "BET", # Retain BET values only
         gear == "PS",     # Retain PS values only
         year >= 2000) |>  # Retain data from 2000
  group_by(year) |>        # Specify that I am grouping by year
  # Tell summarize that I want to collapse the catch column by summing all its values
  summarize(catch = sum(catch))

ps_tuna_data
```

# Exercise 3: Combine your catch and price data

## Part A: Plan the join

1. Think about what type of join you want
2. What will be on the left and what will be on the right?
3. What is the key?
4. Write down, using human language, what you want to do.

**Post-it up**

## Part B: Perform the join
1. Perform the join and save the output to an object called `tuna_revenues`
2. Create a new column that contains the annual revenue in M USD. Pay attention to the units.

**Post-it down**

```{r}
tuna_revenues <- ps_tuna_data |> 
  left_join(tidy_tuna_prices, by = join_by(year)) |> 
  mutate(revenue = price * catch / 1e6)

tuna_revenues
```

## Part C: Answer the questions again

1. How much TOTAL revenue since 2000?
2. How much mean ANNUAL revenue since 2000?
3. Make a figure
4. How do these plot and numbers compare to what we found [last week](https://jcvdav.github.io/EVR_628/docs/06_live.html#part-g-visualize-the-data-and-answer-the-question)?

```{r}
sum(tuna_revenues$revenue)

mean(tuna_revenues$revenue)

# Build  plot
ggplot(data = tuna_revenues,                   # Specify my data
       mapping = aes(x = year, y = revenue)) + # And my aesthetics
  geom_line(linetype = "dashed") +             # Add a dashed line
  geom_point() +                               # With points on top
  labs(x = "Year",                             # Add some labels
       y = "Revenue (M USD)",
       title = "Annual revenue from fishing bigeye tuna by purse seine vessels",
       caption = "Data come from the IATTC") +
  # Modify the theme
  theme_minimal(base_size = 14,               # Font size 14
                base_family = "Times")        # Font family Times
```





